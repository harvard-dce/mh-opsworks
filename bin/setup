#!/usr/bin/env bash

if ! ruby -v | grep -qiE 'ruby 2' ; then
  echo 'You must have ruby 2.x installed'
  exit 1
fi

# Set up Ruby dependencies via Bundler
if ! command -v bundle > /dev/null; then
  echo "Please install bundler via:"
  echo "gem install bundler"
  echo
  echo "If you're using your system ruby, you'll need:"
  echo "sudo gem install bundler"
  exit 1;
fi

bundle install --binstubs

if [ ! -f "./cluster_config.json" ]; then
  cp templates/cluster_config_example.json ./cluster_config.json
  echo 'Creating a new ./cluster_config.json file, be sure to fill it in with your values'
else
  echo 'Using existing ./cluster_config.json'
fi

if [ ! -f "./credentials.json" ]; then
  cp templates/credentials_example.json ./credentials.json
  echo 'Creating a new ./credentials.json file, be sure to fill it in with your credentials'
else
  echo 'Using existing ./credentials.json file'
fi

if grep -qiE 'FILL_ME_IN' ./cluster_config.json; then
  echo 'Be sure to complete configuring your ./cluster_config.json file'
  exit 1;
fi

if grep -qiE 'FILL_ME_IN' ./credentials.json; then
  echo 'Be sure to complete configuring your ./credentials.json file'
  exit 1;
fi


echo 'Preflight checks out. Run `rake admin:cluster:init` to create a matterhorn cluster'
